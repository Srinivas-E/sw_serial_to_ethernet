import sys

# open files
f_i0 = open('./template_start','r')
f_i1 = open('./template','r')
f_i2 = open('./template_end','r')

if (len(sys.argv) == 2):
    print 'Opening '+sys.argv[1]
    f_o = open(sys.argv[1],'w')
else:
    print 'Outputting to ./gen_uart_out.S'
    f_o = open('./gen_uart_out.S','w')

start = f_i0.read();
template = f_i1.read();
end = f_i2.read();

f_i0.close()
f_i1.close()
f_i2.close()

warning  = "/* WARNING - This is an autogenerated file - it is recommended to edit\n"
warning += " * the templates that it was edited from. Please see the /gen directory\n"
warning += " * of this module for details\n"
warning += " */\n\n"
f_o.write(warning)

print "Outputting start code..."
f_o.write(start)

print "Outputting template..."
for i in [0,1,2,3,4,5,6,7]:
    channel_id = i
    chan_count = i+1
    if i == 7:
        next_chan = "rx_bit_ep"
    else:
        next_chan = "process_loop_"+str(i+1)

    template_out = template.replace("`chan_id`", str(channel_id) )
    template_out = template_out.replace("`chan_count`", str(chan_count) )
    template_out = template_out.replace("`next_chan`", str(next_chan) )

    f_o.write(template_out)

print "Writing out finish..."
f_o.write(end)

f_o.close()
print "Done"